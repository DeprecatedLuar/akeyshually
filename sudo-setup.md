# Sudo Setup Feature

## Problem

Users want to run privileged commands via shortcuts (e.g., `sudo systemctl restart kanata`), but interactive password prompts don't work with fire-and-forget execution.

## Solution

Add `akeyshually setup-sudo` command that auto-configures passwordless sudo for commands in config.

## User Flow

1. User writes shortcuts with `sudo` prefix in config:
```toml
[shortcuts]
"super+k" = "sudo systemctl restart kanata"
"super+r" = "sudo reboot"
```

2. Run setup command (one-time):
```bash
akeyshually setup-sudo
# Scans config for sudo commands
# [sudo] password for user: ****
# âœ“ Configured passwordless sudo for 2 commands
```

3. Shortcuts now work without password prompts

4. When adding new sudo shortcuts, re-run `akeyshually setup-sudo`

## Implementation

**File: `internal/commands/setup_sudo.go`**

```go
func SetupSudo() error {
    // 1. Load config
    cfg := config.LoadConfig()

    // 2. Extract all commands starting with "sudo "
    sudoCommands := extractSudoCommands(cfg)

    // 3. Generate sudoers content
    content := generateSudoersFile(sudoCommands, os.Getenv("USER"))

    // 4. Validate with visudo -c
    if err := validateSudoers(content); err != nil {
        return err
    }

    // 5. Write to /etc/sudoers.d/akeyshually using sudo
    return writeSudoersFile(content)
}

func extractSudoCommands(cfg *config.Config) []string {
    var commands []string
    for _, shortcut := range cfg.Shortcuts {
        resolved := cfg.ResolveCommand(shortcut)
        if strings.HasPrefix(resolved, "sudo ") {
            cmd := strings.TrimPrefix(resolved, "sudo ")
            commands = append(commands, cmd)
        }
    }
    return uniqueCommands(commands)
}

func writeSudoersFile(content string) error {
    // Write via: sudo tee /etc/sudoers.d/akeyshually
    // Prompts for password once
}
```

**Generated file: `/etc/sudoers.d/akeyshually`**
```
# Auto-generated by akeyshually setup-sudo
username ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart kanata
username ALL=(ALL) NOPASSWD: /sbin/reboot
```

## Security

- Only commands explicitly in config get NOPASSWD
- User must manually run `setup-sudo` (explicit grant)
- Daemon never runs as root
- Scoped to specific command paths (not wildcards)
- Validates syntax with `visudo -c` before writing

## Alternatives Considered

1. **Run daemon as root** - Rejected: major security risk, config is user-writable
2. **Auto-remap sudo to pkexec** - Rejected: requires polkit agent, breaks on WMs/headless
3. **Manual NOPASSWD setup** - Works but requires maintaining two files (config + sudoers)

## Future Enhancements

- `akeyshually setup-sudo --check` - verify current sudoers matches config
- `akeyshually setup-sudo --remove` - clean up sudoers file
- Detect when sudo commands exist but setup not run (warn on startup)
